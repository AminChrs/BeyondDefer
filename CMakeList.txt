cmake_minimum_required(VERSION 3.12)

# Check if Python is installed
find_program(PYTHON_EXECUTABLE python)
if(NOT PYTHON_EXECUTABLE)
    message(FATAL_ERROR "Python is not installed. Please install Python and try again.")
endif()

# Set the project directory
set(PROJECT_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/..")

# Create a virtual environment
execute_process(
    COMMAND ${PYTHON_EXECUTABLE} -m venv myenv
    WORKING_DIRECTORY ${PROJECT_DIRECTORY}
    RESULT_VARIABLE result
)
if(result)
    message(FATAL_ERROR "Failed to create virtual environment.")
endif()

# Activate the virtual environment
if(WIN32)
    set(activate_command "myenv\\Scripts\\activate")
else()
    set(activate_command "source myenv/bin/activate")
endif()

# Install dependencies from requirements.txt
execute_process(
    COMMAND ${activate_command} && pip install -r requirements.txt
    WORKING_DIRECTORY ${PROJECT_DIRECTORY}
    RESULT_VARIABLE result
)
if(result)
    message(FATAL_ERROR "Failed to install dependencies from requirements.txt.")
endif()

# Deactivate the virtual environment
if(WIN32)
    set(deactivate_command "myenv\\Scripts\\deactivate.bat")
else()
    set(deactivate_command "deactivate")
endif()

execute_process(
    COMMAND ${activate_command} && ${deactivate_command}
    WORKING_DIRECTORY ${PROJECT_DIRECTORY}
    RESULT_VARIABLE result
)
if(result)
    message(FATAL_ERROR "Failed to deactivate the virtual environment.")
endif()